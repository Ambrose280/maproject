{% extends "base.html" %}
{% block title %}Dispatcher Dashboard{% endblock %}
{% block content %}
<h2 class="text-xl font-semibold mb-4">Hello, {{ user.username }}</h2>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <div class="col-span-1 md:col-span-2 map-box">
    <div id="map" style="width:100%;height:100%"></div>
  </div>
</div>

<nav class="flex gap-2 mt-4 mb-3">
  <button class="tab-btn px-3 py-2 bg-white rounded shadow" data-tab="orders">Orders</button>
  <button class="tab-btn px-3 py-2 bg-white rounded shadow" data-tab="maptab">Live Map</button>
  <button class="tab-btn px-3 py-2 bg-white rounded shadow" data-tab="profile">Profile</button>
</nav>

<div id="tab-orders" class="tab-scroll bg-white p-4 rounded shadow hidden">
  <ul id="orders-list" class="space-y-3"></ul>
</div>

<div id="tab-maptab" class="tab-scroll bg-white p-4 rounded shadow hidden">
  <p class="text-sm text-slate-600">Your toggles and controls are in Profile tab. Map auto-updates dispatchers.</p>
</div>

<div id="tab-profile" class="tab-scroll bg-white p-4 rounded shadow hidden">
  <div class="flex items-center gap-4">
    <label class="text-sm">Online</label>
    <input id="statusToggle" type="checkbox" class="h-5 w-10" />
    <div id="statusLabel" class="text-sm text-slate-500">Offline</div>
  </div>
  <p class="text-sm text-slate-500 mt-3" id="last-sync">Last sync: never</p>
</div>
{% endblock %}

{% block scripts %}
<script>
mapboxgl.accessToken = "{{ MAPBOX_TOKEN }}";
const map = new mapboxgl.Map({ container:'map', style:'mapbox://styles/mapbox/streets-v12', center:[7.5,9.0], zoom:6 });
map.addControl(new mapboxgl.NavigationControl());

/* tabs */
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('#tab-orders,#tab-maptab,#tab-profile').forEach(el=>el.classList.add('hidden'));
    document.getElementById('tab-'+b.dataset.tab).classList.remove('hidden');
  });
});
/* default open orders */
document.querySelector('.tab-btn').click();

/* toggle online */
document.getElementById('statusToggle').addEventListener('change', async (e)=>{
  try{
    const res = await fetch('/dispatcher/toggle_online', { method: 'POST' });
    const j = await res.json();
    if(j.online){ document.getElementById('statusLabel').innerText = 'Online'; startTracking(); } else { document.getElementById('statusLabel').innerText = 'Offline'; stopTracking(); }
  }catch(err){ console.error(err); }
});

/* tracking */
let locationInterval = null;
function startTracking(){
  if(!navigator.geolocation) return alert('Geolocation unsupported');
  navigator.geolocation.getCurrentPosition(sendPos);
  locationInterval = setInterval(()=> navigator.geolocation.getCurrentPosition(sendPos), 3000);
}
function stopTracking(){ if(locationInterval){ clearInterval(locationInterval); locationInterval=null; } }
async function sendPos(pos){
  const lat = pos.coords.latitude, long = pos.coords.longitude;
  document.getElementById('last-sync').innerText = 'Last sync: ' + new Date().toLocaleTimeString();
  try{ await fetch('/dispatcher/update_location', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({lat,long}) }); }catch(e){ console.error(e); }
  if(!window.userMarker){ window.userMarker = new mapboxgl.Marker({ color: 'green' }).setLngLat([long,lat]).addTo(map); } else { window.userMarker.setLngLat([long,lat]); }
}

/* orders poll */
async function fetchOrders(){
  try{
    const res = await fetch('/api/orders');
    if(!res.ok) return;
    const data = await res.json();
    const list = document.getElementById('orders-list'); list.innerHTML = '';
    for(const o of data){
      const li = document.createElement('li'); li.className = 'p-3 border rounded flex justify-between items-center';
      li.innerHTML = `<div><b>Order #${o.id}</b><div class="text-sm text-slate-500">${o.title}</div></div><div class="space-x-2"><button class="px-3 py-1 bg-green-600 text-white rounded" onclick="accept(${o.id})">Accept</button><button class="px-3 py-1 bg-red-600 text-white rounded" onclick="decline(${o.id})">Decline</button><button class="px-3 py-1 border rounded" onclick="window.open('/track/${o.code}','_blank')">Track</button></div>`;
      list.appendChild(li);
    }
  }catch(e){ console.error(e); }
}
window.accept = async (id)=>{ await fetch('/dispatcher/accept_order/'+id, { method:'POST' }); fetchOrders(); };
window.decline = async (id)=>{ await fetch('/dispatcher/decline_order/'+id, { method:'POST' }); fetchOrders(); };

setInterval(fetchOrders,3000);
fetchOrders();

/* show other dispatchers on map */
const dispatcherMarkers = {};
async function fetchDispatchers(){
  try{
    const res = await fetch('/api/dispatchers');
    if(!res.ok) return;
    const data = await res.json();
    const bounds = new mapboxgl.LngLatBounds();
    const coords = [];
    for(const d of data){
      if(!d.lat || !d.long) continue;
      coords.push([d.long,d.lat]); bounds.extend([d.long,d.lat]);
      if(dispatcherMarkers[d.id]) {
        const m = dispatcherMarkers[d.id]; const old = m.getLngLat();
        m.setLngLat([ old.lng + (d.long - old.lng) * 0.5, old.lat + (d.lat - old.lat) * 0.5 ]);
      } else {
        const el = document.createElement('div'); el.className='pulse'; el.style.background = d.color || '#0ea5e9';
        const m = new mapboxgl.Marker(el).setLngLat([d.long, d.lat]).setPopup(new mapboxgl.Popup().setText(d.username)).addTo(map);
        dispatcherMarkers[d.id] = m;
      }
    }
    if(coords.length) map.fitBounds(bounds, { padding: 80, maxZoom: 15, duration: 800 });
  }catch(e){ console.error(e); }
}
setInterval(fetchDispatchers, 3000);
fetchDispatchers();
</script>
{% endblock %}
