{% extends "base.html" %}
{% block title %}Dispatcher Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="fw-bold text-primary">Welcome, {{ user.username }}</h3>
  <div>
    <label class="form-check-label me-2 fw-semibold">Online Status:</label>
    <div class="form-check form-switch d-inline">
      <input class="form-check-input" type="checkbox" id="statusToggle">
      <label id="statusLabel" class="form-check-label text-secondary">Offline</label>
    </div>
  </div>
</div>

<div class="bg-white p-4 rounded shadow-sm mb-4">
  <h5 class="fw-bold mb-3">Pending Orders</h5>
  <ul class="list-group" id="orders-list">
    <li class="list-group-item d-flex justify-content-between align-items-center">
      Order #1234 â€” Gas Cylinder (2pcs)
      <div>
        <button class="btn btn-success btn-sm">Accept</button>
        <button class="btn btn-danger btn-sm">Decline</button>
      </div>
    </li>
  </ul>
</div>

<!-- Dispatcher Map -->
<div class="bg-white p-3 rounded shadow-sm">
  <h5 class="fw-bold mb-3">Live Dispatcher Map</h5>
  <div id="map" style="width: 100%; height: 400px; border-radius: 10px;"></div>
</div>

<!-- Dispatcher List -->
<div class="bg-white p-3 rounded shadow-sm mt-4">
  <h5 class="fw-bold mb-3">Online Dispatchers</h5>
  <ul id="dispatchers-list" class="list-group"></ul>
</div>
{% endblock %}

{% block scripts %}
<script src="https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css" rel="stylesheet" />

<script>
mapboxgl.accessToken = "{{ MAPBOX_TOKEN }}";

let map, userMarker = null, watchId = null;
const dispatcherMarkers = {};
let dispatcherData = {};

// --- Initialize Map ---
function initMap() {
  map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v12",
    center: [7.5, 9.0],
    zoom: 6
  });
  map.addControl(new mapboxgl.NavigationControl());
}
document.addEventListener("DOMContentLoaded", initMap);

// --- Time ago function ---
function timeAgo(timestamp) {
  const now = new Date();
  const then = new Date(timestamp);
  const diff = Math.floor((now - then) / 1000);
  if (diff < 10) return "just now";
  if (diff < 60) return `updated ${diff} seconds ago`;
  if (diff < 3600) return `updated ${Math.floor(diff / 60)} minutes ago`;
  return `updated ${Math.floor(diff / 3600)} hours ago`;
}

// --- Update timestamps every second ---
setInterval(() => {
  for (const id in dispatcherData) {
    const d = dispatcherData[id];
    const timeEl = document.getElementById(`time-${id}`);
    if (timeEl) timeEl.textContent = timeAgo(d.last_seen);
  }
}, 1000);

// --- Toggle Online Status ---
document.getElementById("statusToggle").addEventListener("change", async e => {
  const label = document.getElementById("statusLabel");
  try {
    const res = await fetch("/dispatcher/toggle_online", { method: "POST" });
    const data = await res.json();
    if (data.online) {
      label.textContent = "Online";
      label.classList.replace("text-secondary", "text-success");
      startLocationTracking();
    } else {
      label.textContent = "Offline";
      label.classList.replace("text-success", "text-secondary");
      stopLocationTracking();
    }
  } catch (err) { console.error(err); }
});

// --- Location Tracking ---
function startLocationTracking() {
  if (navigator.geolocation) {
    watchId = navigator.geolocation.watchPosition(async pos => {
      const { latitude, longitude } = pos.coords;

      // Update own location every 3 seconds
      await fetch("/dispatcher/update_location", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat: latitude, long: longitude })
      });

      // Update own marker
      if (!userMarker) {
        userMarker = new mapboxgl.Marker({ color: "green" })
          .setLngLat([longitude, latitude])
          .setPopup(new mapboxgl.Popup().setText("You are here"))
          .addTo(map);
      } else {
        userMarker.setLngLat([longitude, latitude]);
      }

    }, null, { maximumAge: 0, enableHighAccuracy: true, timeout: 5000 });
  }
}

function stopLocationTracking() {
  if (watchId) navigator.geolocation.clearWatch(watchId);
}

// --- Fetch All Dispatchers ---
async function fetchDispatchers() {
  try {
    const res = await fetch("/api/dispatchers");
    if (!res.ok) throw new Error("Failed to fetch dispatchers");
    const data = await res.json();

    dispatcherData = {};
    const listEl = document.getElementById("dispatchers-list");
    listEl.innerHTML = "";
    const bounds = new mapboxgl.LngLatBounds();
    const validCoords = [];

    // Include your own location
    if (userMarker) {
      const lngLat = userMarker.getLngLat();
      validCoords.push([lngLat.lng, lngLat.lat]);
    }

    for (const d of data) {
      if (!d.lat || !d.long || isNaN(d.lat) || isNaN(d.long)) continue;
      dispatcherData[d.id] = d;
      validCoords.push([d.long, d.lat]);

      // Smooth marker update
      if (dispatcherMarkers[d.id]) {
        const marker = dispatcherMarkers[d.id];
        const old = marker.getLngLat();
        marker.setLngLat([
          old.lng + (d.long - old.lng) * 0.5,
          old.lat + (d.lat - old.lat) * 0.5
        ]);
      } else {
        const el = document.createElement("div");
        el.className = "pulse";
        el.style.backgroundColor = d.color || "#007bff";
        const marker = new mapboxgl.Marker(el)
          .setLngLat([d.long, d.lat])
          .setPopup(new mapboxgl.Popup().setText(d.username))
          .addTo(map);
        dispatcherMarkers[d.id] = marker;
      }

      // Add to dispatcher list
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `
        <span>
          <span class="me-2" style="width:12px;height:12px;border-radius:50%;background:${d.color}"></span>
          ${d.username}
        </span>
        <small class="text-muted" id="time-${d.id}">${timeAgo(d.last_seen)}</small>
      `;
      listEl.appendChild(li);
    }

    // Remove offline markers
    Object.keys(dispatcherMarkers).forEach(id => {
      if (!data.some(d => d.id === parseInt(id))) {
        dispatcherMarkers[id].remove();
        delete dispatcherMarkers[id];
      }
    });

    // Adjust map to fit all valid coordinates
    if (validCoords.length > 0) {
      validCoords.forEach(c => bounds.extend(c));
      map.fitBounds(bounds, { padding: 80, maxZoom: 15, duration: 1000 });
    }

  } catch (err) {
    console.error("Failed to fetch dispatchers:", err);
  }
}

// --- Poll every 3 seconds ---
setInterval(fetchDispatchers, 3000);
fetchDispatchers();

</script>
{% endblock %}
