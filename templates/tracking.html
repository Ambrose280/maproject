<!DOCTYPE html>
<html>
<head>
    <title>Delivery Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .info-box {
            position: absolute; top: 10px; left: 10px; z-index: 10;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: sans-serif;
        }
    </style>
</head>
<body>

<div class="info-box">
    <strong>Destination:</strong> {{ order.user.full_name }}<br>
    <strong>Item:</strong> {{ order.cylinder.name }}<br>
    <div id="status" style="color: #666; margin-top:5px;">Locating Admin...</div>
</div>

<div id="map"></div>

<script>
    mapboxgl.accessToken = '{{ mapbox_token }}';

    // 1. The Customer's Location (DESTINATION)
    // Passed from backend
    const customerLocation = [{{ order.longitude }}, {{ order.latitude }}];

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: customerLocation, // Start view at customer
        zoom: 13
    });

    // Add Red Marker for Customer
    new mapboxgl.Marker({ color: '#dc3545' }) // Red
        .setLngLat(customerLocation)
        .setPopup(new mapboxgl.Popup().setHTML("<b>Customer Location</b>"))
        .addTo(map);

    // Create Blue Marker for Admin/Driver (Starts hidden/empty)
    const adminMarker = new mapboxgl.Marker({ color: '#0d6efd', scale: 0.8 }) // Blue
        .setLngLat(customerLocation)
        .addTo(map);

    // 2. Function to Draw Route: Admin (Start) -> Customer (End)
    async function getRoute(adminLoc) {
        const start = adminLoc; // [lng, lat]
        const end = customerLocation; // [lng, lat]
        
        const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;
        
        try {
            const query = await fetch(url);
            const json = await query.json();
            
            if (json.routes && json.routes.length > 0) {
                const data = json.routes[0];
                const route = data.geometry.coordinates;
                const duration = Math.floor(data.duration / 60);
                
                document.getElementById('status').innerHTML = `⏱️ Est. Arrival: <b>${duration} mins</b>`;

                const geojson = {
                    type: 'Feature',
                    properties: {},
                    geometry: { type: 'LineString', coordinates: route }
                };

                if (map.getSource('route')) {
                    map.getSource('route').setData(geojson);
                } else {
                    map.addLayer({
                        id: 'route',
                        type: 'line',
                        source: { type: 'geojson', data: geojson },
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#0d6efd', 'line-width': 5, 'line-opacity': 0.75 }
                    });
                }
            }
        } catch (e) {
            console.error("Mapbox Error:", e);
        }
    }

    // 3. Watch Admin's Position Live
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (position) => {
                const adminLng = position.coords.longitude;
                const adminLat = position.coords.latitude;
                const adminLocation = [adminLng, adminLat];

                // Update Blue Marker
                adminMarker.setLngLat(adminLocation);
                
                // Recalculate Route
                getRoute(adminLocation);
                
                // Keep map centered on admin as they drive (optional, removes manual panning)
                // map.flyTo({center: adminLocation, zoom: 14}); 
            },
            (err) => {
                console.error(err);
                document.getElementById('status').innerText = "⚠️ GPS Error: Check permissions";
            },
            { enableHighAccuracy: true }
        );
    } else {
        alert("Geolocation not supported");
    }
</script>

</body>
</html>