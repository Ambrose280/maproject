{% extends "base.html" %}
{% block title %}User Dashboard{% endblock %}
{% block content %}
<h2 class="text-xl font-semibold mb-4">Welcome, {{ user.username if user else 'Guest' }}</h2>

<div class="map-box mb-4 rounded overflow-hidden" style="height:300px">
  <div id="map" class="w-full h-full"></div>
</div>

<!-- Tabs -->
<div>
  <nav class="flex space-x-2 mb-3">
    <button class="tab-btn px-3 py-2 bg-white rounded shadow" data-tab="share">üìç Share Location</button>
    <button class="tab-btn px-3 py-2 bg-white rounded shadow" data-tab="orders">üì¶ Orders</button>
    <button class="tab-btn px-3 py-2 bg-white rounded shadow" data-tab="dispatchers">üö¥ Dispatchers</button>
  </nav>

  <!-- Share Tab -->
  <div id="tab-share" class="tab-content bg-white p-4 rounded shadow">
    <p class="text-sm text-slate-600">Click to get your current location and save it with a name.</p>
    <button id="share-location" class="px-3 py-2 bg-green-600 text-white rounded mt-2">Get current location</button>
    <div id="coords" class="mt-3 text-sm text-slate-700"></div>

    <h4 class="mt-4 font-semibold">Saved Locations</h4>
    <ul id="saved-locations" class="space-y-2 tab-scroll"></ul>
    <!-- .tab-scroll is defined in base.css: max-height + overflow-y -->

    <!-- Save Modal -->
    <div id="saveModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white p-5 rounded w-96 shadow-lg">
        <h3 class="font-semibold text-lg mb-2">Save location</h3>
        <form id="saveLocForm" class="space-y-3">
          <input type="hidden" name="lat" id="loc-lat">
          <input type="hidden" name="long" id="loc-long">
          <div>
            <label class="block text-sm font-medium">Location Name</label>
            <input name="name" id="loc-name" class="w-full border rounded px-2 py-1" placeholder="e.g. Home, Office" required />
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" id="saveCancel" class="px-3 py-1 border rounded">Cancel</button>
            <button type="submit" class="px-3 py-1 bg-sky-600 text-white rounded">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Orders Tab -->
  <div id="tab-orders" class="tab-content hidden bg-white p-4 rounded shadow">
    <div class="flex justify-between items-center mb-3">
      <h4 class="font-semibold text-lg">My Orders</h4>
      <button id="openOrderModal" class="px-3 py-2 bg-sky-600 text-white rounded">+ Create Order</button>
    </div>
    <div id="orders-area" class="tab-scroll"></div>

    <!-- Order Modal -->
    <div id="orderModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white p-5 rounded w-96 shadow-lg">
        <h3 class="font-semibold text-lg mb-2">Place an Order</h3>
        <form id="placeOrderForm" enctype="multipart/form-data" class="space-y-3">
          <input name="title" placeholder="Title" required class="w-full border rounded p-2" />
          <select name="location_id" id="locationSelect" class="w-full border rounded p-2"></select>
          <input type="file" name="image" accept="image/*" required />
          <input type="number" name="quantity" value="1" min="1" class="w-24 border rounded p-2" />
          <div class="flex justify-end space-x-2">
            <button type="button" id="cancelOrderModal" class="px-3 py-1 border rounded">Cancel</button>
            <button class="px-3 py-1 bg-sky-600 text-white rounded">Place</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Share Link Modal (shows generated link & copy button; needed for iOS) -->
    <div id="shareLinkModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white p-5 rounded w-96 shadow-lg">
        <h3 class="font-semibold text-lg mb-2">Share Link</h3>
        <p id="shareLinkText" class="break-all text-sm mb-4"></p>
        <div class="flex justify-end space-x-2">
          <button id="copyShareLink" class="px-3 py-1 bg-sky-600 text-white rounded">Copy</button>
          <button id="closeShareLink" class="px-3 py-1 border rounded">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dispatchers Tab -->
  <div id="tab-dispatchers" class="tab-content hidden bg-white p-4 rounded shadow">
    <ul id="dispatchers-list" class="space-y-2 tab-scroll"></ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
mapboxgl.accessToken = "{{ MAPBOX_TOKEN }}";
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v12',
  center: [3.3792,6.5244],
  zoom: 11
});
map.addControl(new mapboxgl.NavigationControl());

/* orders tab */
async function loadMyOrders(){
  const res = await fetch('/my_orders_json');
  const area = document.getElementById('orders-area');
  area.innerHTML = '';
  if(!res.ok) return;
  const data = await res.json();
  if(data.length === 0){
    area.innerHTML = '<p>No orders yet</p>';
    return;
  }
  for(const o of data){
    const div = document.createElement('div');
    div.className = 'p-3 border rounded mb-2';
    div.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <b>${o.title}</b><br>
          <small class="text-slate-500">Status: ${o.status}</small>
        </div>
        <div class="space-x-2">
          <button onclick="generateShareLink(${o.id})" class="px-3 py-1 border rounded text-sky-600">üîó Share Link</button>
        </div>
      </div>`;
    area.appendChild(div);
  }
}

/* copy helper with fallback for iOS / older browsers */
async function copyToClipboard(text){
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch (err) {
    // fallback using textarea + execCommand
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.setAttribute('readonly', '');
    ta.style.position = 'absolute';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand('copy');
      document.body.removeChild(ta);
      return true;
    } catch (e) {
      document.body.removeChild(ta);
      return false;
    }
  }
}

async function generateShareLink(orderId){
  const res = await fetch('/generate_share_link/' + orderId, { method: 'POST' });
  if(!res.ok) return alert('Error generating link');
  const j = await res.json();
  if(j.link){
    // show modal with link (better UX on iOS)
    const modal = document.getElementById('shareLinkModal');
    const textEl = document.getElementById('shareLinkText');
    textEl.textContent = j.link;
    modal.classList.remove('hidden');

    // attach copy handler (one-off)
    const copyBtn = document.getElementById('copyShareLink');
    const onCopy = async () => {
      const ok = await copyToClipboard(j.link);
      if(ok){
        copyBtn.textContent = 'Copied';
        setTimeout(()=> copyBtn.textContent = 'Copy', 2000);
      } else {
        alert('Copy failed ‚Äî please long-press the link to copy on iOS');
      }
    };
    copyBtn.removeEventListener('click', onCopy);
    copyBtn.addEventListener('click', onCopy);

    document.getElementById('closeShareLink').onclick = () => modal.classList.add('hidden');
    // allow clicking backdrop to close
    modal.addEventListener('click', (ev) => {
      if(ev.target === modal) modal.classList.add('hidden');
    }, { once: true });
  } else {
    alert('Error generating link');
  }
}

loadMyOrders();

/* Tabs with active color */
const tabBtns = document.querySelectorAll('.tab-btn');
tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;
    tabBtns.forEach(b => b.classList.remove('bg-sky-600','text-white'));
    btn.classList.add('bg-sky-600','text-white');

    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('tab-' + tab).classList.remove('hidden');
  });
});
tabBtns[0].click(); // default active

/* Share Location */
document.getElementById('share-location').addEventListener('click', ()=> {
  if(!navigator.geolocation) return alert('Geolocation unsupported');
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude, long = pos.coords.longitude;
    document.getElementById('coords').innerText = `Lat: ${lat.toFixed(6)}, Lng: ${long.toFixed(6)}`;
    document.getElementById('loc-lat').value = lat;
    document.getElementById('loc-long').value = long;
    document.getElementById('saveModal').classList.remove('hidden');
    map.flyTo({ center: [long, lat], zoom: 14 });
    if (!window.userMarker) {
      window.userMarker = new mapboxgl.Marker({ color: '#16a34a' }).setLngLat([long, lat]).addTo(map);
    } else {
      window.userMarker.setLngLat([long, lat]);
    }
  }, err => alert('Unable to get location'));
});
document.getElementById('saveCancel').addEventListener('click', ()=> document.getElementById('saveModal').classList.add('hidden'));

/* Load saved locations */
async function loadLocations(){
  const res = await fetch('/get_all_locations');
  const sel = document.getElementById('locationSelect');
  sel.innerHTML = '';
  const list = document.getElementById('saved-locations');
  list.innerHTML = '';
  if(!res.ok) return;
  const data = await res.json();
  for(const loc of data){
    // For order select
    const o = document.createElement('option');
    o.value = loc.id;
    o.textContent = `${loc.name || 'Saved'} ‚Äî ${new Date(loc.created_at).toLocaleString()}`;
    sel.appendChild(o);

    // For saved locations list
    const li = document.createElement('li');
    li.className = 'flex justify-between items-center p-2 border rounded';
    li.innerHTML = `<span>${loc.name || 'Saved'} ‚Äî ${new Date(loc.created_at).toLocaleString()}</span>
      <button class="text-red-600 font-bold" onclick="deleteLocation(${loc.id})">&times;</button>`;
    list.appendChild(li);
  }
}
loadLocations();

/* Delete location */
async function deleteLocation(id){
  if(!confirm('Delete this location?')) return;
  const res = await fetch(`/delete_location/${id}`, { method: 'DELETE' });
  if(res.ok) loadLocations();
}

/* Save location */
document.getElementById('saveLocForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/save_location', { method: 'POST', body: fd });
  const j = await res.json();
  if(j.id){
    document.getElementById('saveModal').classList.add('hidden');
    loadLocations();
  }
});

/* Order modal controls */
document.getElementById('openOrderModal').addEventListener('click', ()=> document.getElementById('orderModal').classList.remove('hidden'));
document.getElementById('cancelOrderModal').addEventListener('click', ()=> document.getElementById('orderModal').classList.add('hidden'));

/* Place order */
document.getElementById('placeOrderForm').addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/place_order', { method: 'POST', body: fd });
  const j = await res.json();
  if(j.order_id){
    document.getElementById('orderModal').classList.add('hidden');
    loadMyOrders();
  }
});


/* Dispatchers */
const dispatcherMarkers = {};
async function fetchDispatchers(){
  try{
    const res = await fetch('/api/dispatchers');
    if(!res.ok) return;
    const data = await res.json();
    const list = document.getElementById('dispatchers-list');
    list.innerHTML = '';
    const bounds = new mapboxgl.LngLatBounds();
    const coords = [];
    for(const d of data){
      if(!d.lat || !d.long) continue;
      coords.push([d.long, d.lat]);
      bounds.extend([d.long, d.lat]);
      if(dispatcherMarkers[d.id]){
        dispatcherMarkers[d.id].setLngLat([d.long, d.lat]);
      } else {
        const el = document.createElement('div');
        el.className = 'pulse';
        el.style.background = d.color || '#0ea5e9';
        dispatcherMarkers[d.id] = new mapboxgl.Marker(el)
          .setLngLat([d.long, d.lat])
          .setPopup(new mapboxgl.Popup().setText(d.username))
          .addTo(map);
      }
      const li = document.createElement('li');
      li.className = 'p-2 border rounded flex justify-between';
      li.innerHTML = `<div><span class="inline-block w-3 h-3 rounded-full mr-2" style="background:${d.color}"></span>${d.username}</div>
        <div class="text-xs text-slate-500">${new Date(d.last_seen).toLocaleTimeString()}</div>`;
      list.appendChild(li);
    }
    if(coords.length) map.fitBounds(bounds, { padding: 40, maxZoom: 15 });
  }catch(err){ console.error(err); }
}
fetchDispatchers();
setInterval(fetchDispatchers, 4000);
</script>
{% endblock %}
