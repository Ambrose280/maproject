{% extends "base.html" %}
{% block title %}User Dashboard{% endblock %}

{% block head %}
<script src="https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css" rel="stylesheet" />

<style>
  .map-container {
    width: 100%;
    max-width: 600px;
    aspect-ratio: 1 / 1;
    margin: 0 auto;
    border-radius: 1rem;
    background: #fff;
    box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.1);
    overflow: hidden;
    border: 1px solid #dee2e6;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  .pulse {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    position: relative;
    box-shadow: 0 0 0 rgba(0, 0, 0, 0.2);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4);
    }
    70% {
      box-shadow: 0 0 0 15px rgba(0, 123, 255, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
    }
  }
</style>
{% endblock %}

{% block content %}
<h3 class="fw-bold mb-4 text-primary">Welcome, {{ user }}</h3>

<!-- Square Map Box -->
<div class="map-container mb-4">
  <div id="map"></div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mt-4" id="userTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#share">üìç Share Location</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dispatchers">üß≠ Dispatchers</button>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content mt-3">
  <!-- Share Location -->
  <div class="tab-pane fade show active" id="share">
    <p class="text-muted">Click to share your live location.</p>
    <button id="share-location" class="btn btn-success">Share My Location</button>
    <div id="coords" class="mt-3"></div>
  </div>

  <!-- Dispatchers List -->
  <div class="tab-pane fade" id="dispatchers">
    <ul id="dispatchers-list" class="list-group"></ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
mapboxgl.accessToken = "{{ MAPBOX_TOKEN }}";
const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/streets-v12",
  center: [3.3792, 6.5244],
  zoom: 12
});
map.addControl(new mapboxgl.NavigationControl());

const dispatcherMarkers = {};
let dispatcherData = {};

function timeAgo(timestamp) {
  const now = new Date();
  const then = new Date(timestamp);
  const diff = Math.floor((now - then) / 1000);
  if (diff < 10) return "just now";
  if (diff < 60) return `updated ${diff} seconds ago`;
  if (diff < 3600) return `updated ${Math.floor(diff / 60)} minutes ago`;
  return `updated ${Math.floor(diff / 3600)} hours ago`;
}

// Live timestamp refresh
setInterval(() => {
  for (const id in dispatcherData) {
    const d = dispatcherData[id];
    const timeEl = document.getElementById(`time-${id}`);
    if (timeEl) timeEl.textContent = timeAgo(d.last_seen);
  }
}, 1000);

map.on("load", () => {
  fetchDispatchers();
  setInterval(fetchDispatchers, 5000);
});

async function fetchDispatchers() {
  try {
    const res = await fetch("/api/dispatchers");
    if (!res.ok) throw new Error("Failed to fetch dispatchers");
    const data = await res.json();

    const bounds = new mapboxgl.LngLatBounds();
    const listEl = document.getElementById("dispatchers-list");

    for (const d of data) {
      if (!d.lat || !d.long || isNaN(d.lat) || isNaN(d.long)) continue;
      const coords = [d.long, d.lat];
      dispatcherData[d.id] = d;
      bounds.extend(coords);

      // Marker update / creation
      if (dispatcherMarkers[d.id]) {
        const marker = dispatcherMarkers[d.id];
        const old = marker.getLngLat();
        const newLng = old.lng + (coords[0] - old.lng) * 0.5;
        const newLat = old.lat + (coords[1] - old.lat) * 0.5;
        marker.setLngLat([newLng, newLat]);
      } else {
        const el = document.createElement("div");
        el.className = "pulse";
        el.style.backgroundColor = d.color || "#007bff";
        const marker = new mapboxgl.Marker(el)
          .setLngLat(coords)
          .setPopup(new mapboxgl.Popup().setText(d.username))
          .addTo(map);
        dispatcherMarkers[d.id] = marker;
      }

      // Update or create list entry
      let li = document.getElementById(`dispatcher-${d.id}`);
      if (!li) {
        li = document.createElement("li");
        li.id = `dispatcher-${d.id}`;
        li.className = "list-group-item d-flex align-items-center justify-content-between";
        listEl.appendChild(li);
      }
      li.innerHTML = `
        <span>
          <span class="me-2" style="width:12px;height:12px;border-radius:50%;background:${d.color || "#007bff"}"></span>
          ${d.username}
        </span>
        <small class="text-muted" id="time-${d.id}">${timeAgo(d.last_seen)}</small>
      `;
    }

    // Remove offline dispatchers (no longer returned)
    Object.keys(dispatcherMarkers).forEach(id => {
      if (!data.some(d => d.id === parseInt(id))) {
        dispatcherMarkers[id].remove();
        delete dispatcherMarkers[id];
        delete dispatcherData[id];
        const li = document.getElementById(`dispatcher-${id}`);
        if (li) li.remove();
      }
    });

    // Adjust map bounds
    if (data.length > 1) {
      map.fitBounds(bounds, { padding: 50, duration: 1000 });
    } else if (data.length === 1) {
      map.flyTo({ center: [data[0].long, data[0].lat], zoom: 14, speed: 0.8, curve: 1.4 });
    }

  } catch (err) {
    console.error("Dispatcher update failed:", err);
  }
}

// Share Live Location
document.getElementById("share-location").onclick = () => {
  if (!navigator.geolocation) return alert("Geolocation not supported");
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    document.getElementById("coords").innerText =
      `Lat: ${latitude.toFixed(5)}, Lng: ${longitude.toFixed(5)}`;

    const userMarker = new mapboxgl.Marker({ color: "#28a745" })
      .setLngLat([longitude, latitude])
      .addTo(map)
      .setPopup(new mapboxgl.Popup().setText("You are here"));

    map.flyTo({ center: [longitude, latitude], zoom: 14, speed: 0.8, curve: 1.4 });
  });
};
</script>
{% endblock %}
