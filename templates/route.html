{% extends "adminbase.html" %}
{% block title %}Delivery Route | Gas Orders{% endblock %}

{% block content %}
<div id="main-content" class="text-center py-6">
  <a href="/" class="text-xl font-bold text-blue-600">Home Page</a>
  <h1 class="text-2xl font-bold mb-4">üöö Delivery Route Tracker</h1>
  <p class="text-gray-600 mb-4">
    Delivering to: <strong>{{ customer_location.name }}</strong>
  </p>
  <p id="eta" class="text-lg font-semibold text-green-600 mb-3"></p>
  <div id="map" class="w-full h-96 rounded-lg shadow-md border-2 border-blue-400 mx-auto"></div>
</div>

<script>
mapboxgl.accessToken = "{{ mapbox_token }}";

document.addEventListener("DOMContentLoaded", () => {
  const customer = {
    lat: {{ customer_location.lat }},
    lng: {{ customer_location.long }},
    name: "{{ customer_location.name }}"
  };

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [customer.lng, customer.lat],
    zoom: 13
  });

  map.addControl(new mapboxgl.NavigationControl());

  // Customer marker
  new mapboxgl.Marker({ color: 'red' })
    .setLngLat([customer.lng, customer.lat])
    .setPopup(new mapboxgl.Popup().setText("Customer: " + customer.name))
    .addTo(map);

  map.on('load', () => {
    trackDelivery(map, customer);
  });
});

function trackDelivery(map, customer) {
  if (!navigator.geolocation) {
    alert("Geolocation not supported.");
    return;
  }

  navigator.geolocation.watchPosition(async pos => {
    const lng = pos.coords.longitude;
    const lat = pos.coords.latitude;

    // Create pulsing arrow marker
    if (!window.deliveryMarkerEl) {
      const el = document.createElement('div');
      el.className = 'pulse-arrow';
      el.innerHTML = `
        <div class="pulse-ring"></div>
        <div class="arrow-icon">‚¨ÜÔ∏è</div>
      `;
      el.style.position = 'relative';
      el.style.width = '40px';
      el.style.height = '40px';
      el.style.display = 'flex';
      el.style.justifyContent = 'center';
      el.style.alignItems = 'center';

      window.deliveryMarkerEl = el;
      window.deliveryMarker = new mapboxgl.Marker(el)
        .setLngLat([lng, lat])
        .setPopup(new mapboxgl.Popup().setText("You (Deliveryman)"))
        .addTo(map);
    } else {
      window.deliveryMarker.setLngLat([lng, lat]);
    }

    // Get route and ETA
    const routeData = await getRoute([lng, lat], [customer.lng, customer.lat]);
    const { route, etaMinutes, bearing } = routeData;

    // Show ETA
    document.getElementById("eta").textContent = `‚è±Ô∏è ETA: ${etaMinutes} min`;

    // Rotate arrow toward direction of travel
    const arrow = window.deliveryMarkerEl.querySelector(".arrow-icon");
    arrow.style.transform = `rotate(${bearing}deg)`;

    // Update route on map
    if (map.getSource('route')) {
      map.getSource('route').setData(route);
    } else {
      map.addSource('route', { type: 'geojson', data: route });
      map.addLayer({
        id: 'routeLine',
        type: 'line',
        source: 'route',
        layout: { 'line-join': 'round', 'line-cap': 'round' },
        paint: { 'line-color': '#007bff', 'line-width': 5, 'line-opacity': 0.8 }
      });

      map.addLayer({
        id: 'routeArrows',
        type: 'symbol',
        source: 'route',
        layout: {
          'symbol-placement': 'line',
          'text-field': '‚û§',
          'text-size': 18,
          'text-keep-upright': false
        },
        paint: { 'text-color': '#1e90ff', 'text-opacity': 0.9 }
      });
    }

    // Adjust bounds
    const bounds = new mapboxgl.LngLatBounds();
    route.features[0].geometry.coordinates.forEach(coord => bounds.extend(coord));
    map.fitBounds(bounds, { padding: 100, maxZoom: 15, duration: 1000 });

    // Arrival detection
    const distance = getDistanceInMeters(lat, lng, customer.lat, customer.lng);
    if (distance <= 10 && !window.arrived) {
      window.arrived = true;
      new mapboxgl.Popup()
        .setLngLat([customer.lng, customer.lat])
        .setHTML("<b>‚úÖ Delivery completed!</b>")
        .addTo(map);
      alert("‚úÖ You‚Äôve arrived at the customer‚Äôs location!");
    }
  }, err => console.error(err), { enableHighAccuracy: true });
}

// Fetch route and calculate ETA
async function getRoute(start, end) {
  const res = await fetch(
    `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&geometries=geojson&overview=full&access_token={{ mapbox_token }}`
  );
  const json = await res.json();
  const data = json.routes[0];
  const etaMinutes = Math.round(data.duration / 60); // ETA in minutes
  const coords = data.geometry.coordinates;
  const bearing = calculateBearing(coords[0], coords[1]); // direction toward destination

  return {
    route: {
      type: 'FeatureCollection',
      features: [{ type: 'Feature', geometry: data.geometry }]
    },
    etaMinutes,
    bearing
  };
}

// Calculate bearing between two coordinates
function calculateBearing(start, end) {
  const startLat = start[1] * Math.PI / 180;
  const startLng = start[0] * Math.PI / 180;
  const endLat = end[1] * Math.PI / 180;
  const endLng = end[0] * Math.PI / 180;

  const y = Math.sin(endLng - startLng) * Math.cos(endLat);
  const x = Math.cos(startLat) * Math.sin(endLat) -
            Math.sin(startLat) * Math.cos(endLat) * Math.cos(endLng - startLng);
  const bearing = Math.atan2(y, x) * 180 / Math.PI;
  return (bearing + 360) % 360;
}

// Distance formula
function getDistanceInMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1 * Math.PI/180) *
            Math.cos(lat2 * Math.PI/180) *
            Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
</script>

<style>
/* Pulse effect */
.pulse-ring {
  position: absolute;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(0, 200, 0, 0.5);
  border-radius: 50%;
  animation: pulse 1.5s infinite;
}

.arrow-icon {
  font-size: 22px;
  color: green;
  z-index: 2;
  transform: rotate(0deg);
  transition: transform 0.2s linear;
}

@keyframes pulse {
  0% {
    transform: scale(0.8);
    opacity: 0.7;
  }
  70% {
    transform: scale(1.5);
    opacity: 0.2;
  }
  100% {
    transform: scale(0.8);
    opacity: 0.7;
  }
}
</style>
{% endblock %}
