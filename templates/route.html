-- Active: 1760591715735@@postgresql-ifiok-ambrose.alwaysdata.net@5432
{% extends "adminbase.html" %}
{% block title %}Delivery Route | Gas Orders{% endblock %}

{% block content %}
<div id="main-content" class="text-center py-6">
  <a href="/" class="text-xl font-bold text-blue-600">Home Page</a>
  <h1 class="text-2xl font-bold mb-4">ðŸšš Delivery Route Tracker</h1>
  <p class="text-gray-600 mb-4">
    Delivering to: <strong>{{ customer_location.name }}</strong>
  </p>
  <div id="map" class="w-full h-96 rounded-lg shadow-md border-2 border-blue-400 mx-auto"></div>
</div>

<script>
mapboxgl.accessToken = "{{ mapbox_token }}";

document.addEventListener("DOMContentLoaded", () => {
  const customer = {
    lat: {{ customer_location.lat }},
    lng: {{ customer_location.long }},
    name: "{{ customer_location.name }}"
  };

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [customer.lng, customer.lat],
    zoom: 13,
    interactive: false
  });

  // Disable controls
  map.scrollZoom.disable();
  map.dragPan.disable();
  map.doubleClickZoom.disable();
  map.touchZoomRotate.disable();

  // Customer marker (no pulse)
  new mapboxgl.Marker({ color: 'red' })
    .setLngLat([customer.lng, customer.lat])
    .setPopup(new mapboxgl.Popup().setText("Customer: " + customer.name))
    .addTo(map);

  // Route line source
  map.on('load', () => {
    map.addSource('route', {
      type: 'geojson',
      data: { type: 'FeatureCollection', features: [] }
    });

    map.addLayer({
      id: 'routeLine',
      type: 'line',
      source: 'route',
      layout: { 'line-cap': 'round', 'line-join': 'round' },
      paint: { 'line-color': '#1e90ff', 'line-width': 4, 'line-opacity': 0.7 }
    });

    trackDelivery(map, customer);
  });
});

function trackDelivery(map, customer) {
  if (!navigator.geolocation) {
    alert("Geolocation not supported.");
    return;
  }

  navigator.geolocation.watchPosition(pos => {
    const lng = pos.coords.longitude;
    const lat = pos.coords.latitude;

    // Deliveryman marker
    if (!window.deliveryMarker) {
      window.deliveryMarker = new mapboxgl.Marker({ color: 'green' })
        .setLngLat([lng, lat])
        .setPopup(new mapboxgl.Popup().setText("You (Deliveryman)"))
        .addTo(map);
    } else {
      window.deliveryMarker.setLngLat([lng, lat]);
    }

    // Route line from deliveryman to customer
    const routeGeoJSON = {
      type: 'FeatureCollection',
      features: [{
        type: 'Feature',
        geometry: { type: 'LineString', coordinates: [[lng, lat], [customer.lng, customer.lat]] }
      }]
    };
    map.getSource('route')?.setData(routeGeoJSON);

    // Fit both points into view
    const bounds = new mapboxgl.LngLatBounds();
    bounds.extend([lng, lat]);
    bounds.extend([customer.lng, customer.lat]);
    map.fitBounds(bounds, { padding: 100, maxZoom: 15, duration: 1000 });

    // Compare distance
    const distance = getDistanceInMeters(lat, lng, customer.lat, customer.lng);
    console.log("Distance to customer:", distance.toFixed(1), "m");

    if (distance <= 10 && !window.arrived) {
      window.arrived = true;
      new mapboxgl.Popup()
        .setLngLat([customer.lng, customer.lat])
        .setHTML("<b>âœ… Delivery completed!</b>")
        .addTo(map);
      alert("âœ… Youâ€™ve arrived at the customerâ€™s location!");
    }
  }, err => console.error(err), { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
}

// Haversine formula to calculate distance in meters
function getDistanceInMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1 * Math.PI/180) *
            Math.cos(lat2 * Math.PI/180) *
            Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
</script>

{% endblock %}
