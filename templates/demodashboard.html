{% extends "base.html" %}
{% block title %}User Dashboard{% endblock %}
{% block content %}
<h2 class="text-xl font-semibold mb-4">Welcome, {{ user.email if user else 'Guest' }}</h2>

<div class="map-box mb-4 rounded overflow-hidden" style="height:300px">
  <div id="map" class="w-full h-full"></div>
</div>

<!-- Tabs -->
<div>
  <nav class="flex space-x-2 mb-3">
    <button class="tab-btn px-3 py-2 bg-white rounded shadow" data-tab="share">üìç Share Location</button>
    <button class="tab-btn px-3 py-2 bg-white rounded shadow" data-tab="dispatchers">üö¥ Dispatchers</button>
  </nav>

  <!-- Share Tab -->
  <div id="tab-share" class="tab-content bg-white p-4 rounded shadow">
    <p class="text-sm text-slate-600">Click to get your current location and save it with a name.</p>
    <button id="share-location" class="px-3 py-2 bg-green-600 text-white rounded mt-2">Get current location</button>
    <div id="coords" class="mt-3 text-sm text-slate-700"></div>

    <h4 class="mt-4 font-semibold">Saved Locations</h4>
    <ul id="saved-locations" class="space-y-2 tab-scroll"></ul>
    <!-- .tab-scroll is defined in base.css: max-height + overflow-y -->

    <!-- Save Modal -->
    <div id="saveModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white p-5 rounded w-96 shadow-lg">
        <h3 class="font-semibold text-lg mb-2">Save location</h3>
        <form id="saveLocForm" class="space-y-3">
          <input type="hidden" name="lat" id="loc-lat">
          <input type="hidden" name="long" id="loc-long">
          <div>
            <label class="block text-sm font-medium">Location Name</label>
            <input name="name" id="loc-name" class="w-full border rounded px-2 py-1" placeholder="e.g. Home, Office" required />
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" id="saveCancel" class="px-3 py-1 border rounded">Cancel</button>
            <button type="submit" class="px-3 py-1 bg-sky-600 text-white rounded">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Dispatchers Tab -->
  <div id="tab-dispatchers" class="tab-content hidden bg-white p-4 rounded shadow">
    <ul id="dispatchers-list" class="space-y-2 tab-scroll"></ul>
  </div>
</div>
{% endblock %}

{% block head %}
<style>
/* pulsing marker style (local to this page) */
@keyframes demo-pulse {
  0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(0,0,0,0.12); }
  60% { transform: scale(1.08); opacity: 0.85; box-shadow: 0 0 0 10px rgba(0,0,0,0); }
  100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(0,0,0,0); }
}
.pulse-marker {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 3px solid white;
  box-sizing: border-box;
  animation: demo-pulse 2000ms infinite;
  display: block;
  cursor: pointer;
}
</style>
{% endblock %}

{% block scripts %}
<script>
mapboxgl.accessToken = "{{ MAPBOX_TOKEN }}";
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v12',
  center: [3.3792,6.5244],
  zoom: 11
});
map.addControl(new mapboxgl.NavigationControl());

/* Tabs with active color */
const tabBtns = document.querySelectorAll('.tab-btn');
tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;
    tabBtns.forEach(b => b.classList.remove('bg-sky-600','text-white'));
    btn.classList.add('bg-sky-600','text-white');

    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('tab-' + tab).classList.remove('hidden');
  });
});
tabBtns[0].click(); // default active

/* Share Location */
document.getElementById('share-location').addEventListener('click', ()=> {
  if(!navigator.geolocation) return alert('Geolocation unsupported');
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude, long = pos.coords.longitude;
    document.getElementById('coords').innerText = `Lat: ${lat.toFixed(6)}, Lng: ${long.toFixed(6)}`;
    document.getElementById('loc-lat').value = lat;
    document.getElementById('loc-long').value = long;
    document.getElementById('saveModal').classList.remove('hidden');
    map.flyTo({ center: [long, lat], zoom: 14 });
    if (!window.userMarker) {
      window.userMarker = new mapboxgl.Marker({ color: '#16a34a' }).setLngLat([long, lat]).addTo(map);
    } else {
      window.userMarker.setLngLat([long, lat]);
    }
  }, err => alert('Unable to get location'));
});
document.getElementById('saveCancel').addEventListener('click', ()=> document.getElementById('saveModal').classList.add('hidden'));

/* Load saved locations */
async function loadLocations(){
  const res = await fetch('/get_all_locations');
  const sel = document.getElementById('locationSelect');
  if(sel) sel.innerHTML = '';
  const list = document.getElementById('saved-locations');
  list.innerHTML = '';
  if(!res.ok) return;
  const data = await res.json();
  for(const loc of data){
    // For order select (if present elsewhere)
    if(sel){
      const o = document.createElement('option');
      o.value = loc.id;
      o.textContent = `${loc.name || 'Saved'} ‚Äî ${new Date(loc.created_at).toLocaleString()}`;
      sel.appendChild(o);
    }

    // For saved locations list
    const li = document.createElement('li');
    li.className = 'flex justify-between items-center p-2 border rounded';
    li.innerHTML = `<span>${loc.name || 'Saved'} ‚Äî ${new Date(loc.created_at).toLocaleString()}</span>
      <button class="text-red-600 font-bold" onclick="deleteLocation(${loc.id})">&times;</button>`;
    list.appendChild(li);
  }
}
loadLocations();

/* Delete location */
async function deleteLocation(id){
  if(!confirm('Delete this location?')) return;
  const res = await fetch(`/delete_location/${id}`, { method: 'DELETE' });
  if(res.ok) loadLocations();
}

/* Save location */
document.getElementById('saveLocForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/save_location', { method: 'POST', body: fd });
  const j = await res.json();
  if(j.id){
    document.getElementById('saveModal').classList.add('hidden');
    loadLocations();
  }
});

/* Dispatchers */
const dispatcherMarkers = {};
async function fetchDispatchers(){
  try{
    // use demo endpoint for the hard-coded demo list
    const res = await fetch('/demo/dispatchers');
    if(!res.ok) return;
    const data = await res.json();
    const list = document.getElementById('dispatchers-list');
    list.innerHTML = '';
    const bounds = new mapboxgl.LngLatBounds();
    const coords = [];
    for(const d of data){
      if(!d.lat || !d.long) continue;
      coords.push([d.long, d.lat]);
      bounds.extend([d.long, d.lat]);
      const displayName = ((d.first_name || '') + ' ' + (d.last_name || '')).trim() || d.email;
      const contact = d.phone ? ` ‚Ä¢ ${d.phone}` : '';
      if(dispatcherMarkers[d.id]){
        dispatcherMarkers[d.id].setLngLat([d.long, d.lat]);
      } else {
        const el = document.createElement('div');
        el.className = 'pulse';
        el.style.background = d.color || '#0ea5e9';
        dispatcherMarkers[d.id] = new mapboxgl.Marker(el)
          .setLngLat([d.long, d.lat])
          .setPopup(new mapboxgl.Popup().setText(displayName + contact))
          .addTo(map);
      }
      const li = document.createElement('li');
      li.className = 'p-2 border rounded flex justify-between';
      li.innerHTML = `<div><span class="inline-block w-3 h-3 rounded-full mr-2" style="background:${d.color}"></span>${displayName}${contact}</div>
        <div class="text-xs text-slate-500">${new Date(d.last_seen).toLocaleTimeString()}</div>`;
      list.appendChild(li);
    }
    if(coords.length) map.fitBounds(bounds, { padding: 40, maxZoom: 15 });
  }catch(err){ console.error(err); }
}
fetchDispatchers();
setInterval(fetchDispatchers, 4000);

/* Hardcoded demo points */
const now_iso = new Date().toISOString();
const demoDispatchers = [
  {"id":1001,"first_name":"Ubong","last_name":"Jones","email":"ubong.jones@example.com","phone":"+2348012345678","lat":5.0321533867828725,"long":7.9411077353157085,"color":"#e6194b","last_seen":now_iso},
  {"id":1002,"first_name":"Unwana","last_name":"Ambrose","email":"unwana.ambrose@example.com","phone":"+2348098765432","lat":5.015993712106818,"long":7.9289197784636825,"color":"#3cb44b","last_seen":now_iso},
  {"id":1003,"first_name":"Ifiok","last_name":"Ambrose","email":"ifiok.ambrose@example.com","phone":"+2348071122334","lat":5.011504842537115,"long":7.957029326837196,"color":"#4363d8","last_seen":now_iso}
];

const markers = {};
const listEl = document.getElementById('dispatchers-list');

function renderDemoMarkers() {
  try { map.resize(); } catch(e) {}
  listEl.innerHTML = '';
  const bounds = new mapboxgl.LngLatBounds();

  for (const d of demoDispatchers) {
    if (typeof d.long !== 'number' || typeof d.lat !== 'number') continue;
    const coord = [d.long, d.lat];
    bounds.extend(coord);

    // marker element
    const el = document.createElement('div');
    el.className = 'pulse-marker';
    el.style.background = d.color || '#16a34a';
    el.style.zIndex = 10;

    // ensure marker is centered exactly at the coordinate
    if (!markers[d.id]) {
      markers[d.id] = new mapboxgl.Marker({ element: el, anchor: 'center' })
        .setLngLat(coord)
        .setPopup(new mapboxgl.Popup({ offset: 12 }).setHTML(`<strong>${(d.first_name + ' ' + d.last_name).trim()}</strong><div class="text-xs">${d.phone}</div>`))
        .addTo(map);
    } else {
      markers[d.id].setLngLat(coord);
    }

    // list entry
    const li = document.createElement('li');
    li.className = 'p-2 border rounded flex justify-between items-center';
    li.innerHTML = `<div><strong>${(d.first_name + ' ' + d.last_name).trim()}</strong><div class="text-xs text-slate-500">${d.phone}</div></div><div class="text-xs text-slate-500">${new Date(d.last_seen).toLocaleTimeString()}</div>`;
    listEl.appendChild(li);
  }

  // ensure layout then fit bounds
  try { map.resize(); } catch(e) {}
  const validCount = demoDispatchers.filter(d => typeof d.long === 'number' && typeof d.lat === 'number').length;
  if (validCount === 1) {
    const p = demoDispatchers.find(d => typeof d.long === 'number' && typeof d.lat === 'number');
    map.easeTo({ center: [p.long, p.lat], zoom: 14, duration: 600 });
  } else if (validCount > 1) {
    map.fitBounds(bounds, { padding: 80, maxZoom: 15, duration: 800 });
  }
}

// render after map ready
if (map.loaded()) {
  renderDemoMarkers();
} else {
  map.on('load', renderDemoMarkers);
}
</script>
{% endblock %}
