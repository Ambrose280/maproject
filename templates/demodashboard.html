{% extends "base.html" %}
{% block title %}User Dashboard{% endblock %}

{% block content %}
<h2 class="text-xl font-semibold mb-4">Welcome, {{ user.email if user else 'Guest' }}</h2>

<div class="map-box mb-4 rounded overflow-hidden" style="height:300px">
  <div id="map" class="w-full h-full"></div>
</div>

<!-- Tabs -->
<div>
  <nav class="flex space-x-2 mb-3">
    <button class="tab-btn px-3 py-2 bg-white rounded shadow" data-tab="share">üìç Share Location</button>
    <button class="tab-btn px-3 py-2 bg-white rounded shadow" data-tab="dispatchers">üö¥ Dispatchers</button>
  </nav>

  <!-- Share Tab -->
  <div id="tab-share" class="tab-content bg-white p-4 rounded shadow">
    <p class="text-sm text-slate-600">Click to get your current location and save it with a name.</p>
    <button id="share-location" class="px-3 py-2 bg-green-600 text-white rounded mt-2">Get current location</button>
    <div id="coords" class="mt-3 text-sm text-slate-700"></div>

    <h4 class="mt-4 font-semibold">Saved Locations</h4>
    <ul id="saved-locations" class="space-y-2 tab-scroll"></ul>

    <!-- Save Modal -->
    <div id="saveModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
      <div class="bg-white p-5 rounded w-96 shadow-lg">
        <h3 class="font-semibold text-lg mb-2">Save location</h3>
        <form id="saveLocForm" class="space-y-3">
          <input type="hidden" name="lat" id="loc-lat">
          <input type="hidden" name="long" id="loc-long">
          <div>
            <label class="block text-sm font-medium">Location Name</label>
            <input name="name" id="loc-name" class="w-full border rounded px-2 py-1" placeholder="e.g. Home, Office" required />
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" id="saveCancel" class="px-3 py-1 border rounded">Cancel</button>
            <button type="submit" class="px-3 py-1 bg-sky-600 text-white rounded">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Dispatchers Tab -->
  <div id="tab-dispatchers" class="tab-content hidden bg-white p-4 rounded shadow">
    <ul id="dispatchers-list" class="space-y-2 tab-scroll"></ul>
  </div>
</div>
{% endblock %}

{% block head %}
<style>
@keyframes demo-pulse {
  0% { transform: scale(1); opacity: 1; }
  60% { transform: scale(1.08); opacity: 0.85; box-shadow: 0 0 0 10px rgba(0,0,0,0); }
  100% { transform: scale(1); opacity: 1; }
}
.pulse-marker {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 3px solid white;
  box-sizing: border-box;
  animation: demo-pulse 2000ms infinite;
}
</style>
{% endblock %}

{% block scripts %}
<script>
mapboxgl.accessToken = "{{ MAPBOX_TOKEN }}";
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v12',
  center: [7.94, 5.03],
  zoom: 10
});
map.addControl(new mapboxgl.NavigationControl());

// Tabs
const tabBtns = document.querySelectorAll('.tab-btn');
tabBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;
    tabBtns.forEach(b => b.classList.remove('bg-sky-600','text-white'));
    btn.classList.add('bg-sky-600','text-white');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('tab-' + tab).classList.remove('hidden');
  });
});
tabBtns[0].click(); // default active

// Demo Dispatchers (3 points)
const demoDispatchers = [
  { id:1001, first_name:"Ubong", last_name:"Jones", phone:"+2348012345678", lat:5.0321533867828725, long:7.9411077353157085, color:"#e6194b" },
  { id:1002, first_name:"Unwana", last_name:"Ambrose", phone:"+2348098765432", lat:5.015993712106818, long:7.9289197784636825, color:"#3cb44b" },
  { id:1003, first_name:"Ifiok", last_name:"Ambrose", phone:"+2348071122334", lat:5.011504842537115, long:7.957029326837196, color:"#4363d8" }
];

const markers = {};
const listEl = document.getElementById('dispatchers-list');

function renderDemoMarkers() {
  listEl.innerHTML = '';
  const bounds = new mapboxgl.LngLatBounds();

  demoDispatchers.forEach(d => {
    const coord = [d.long, d.lat];
    bounds.extend(coord);

    const el = document.createElement('div');
    el.className = 'pulse-marker';
    el.style.background = d.color;

    if (!markers[d.id]) {
      markers[d.id] = new mapboxgl.Marker({ element: el, anchor: 'center' })
        .setLngLat(coord)
        .setPopup(new mapboxgl.Popup({ offset: 12 }).setHTML(
          `<strong>${d.first_name} ${d.last_name}</strong><br><small>${d.phone}</small>`
        ))
        .addTo(map);
    } else {
      markers[d.id].setLngLat(coord);
    }

    const li = document.createElement('li');
    li.className = 'p-2 border rounded flex justify-between items-center';
    li.innerHTML = `<div><strong>${d.first_name} ${d.last_name}</strong><div class="text-xs text-slate-500">${d.phone}</div></div>`;
    listEl.appendChild(li);
  });

  // Auto fit once all markers loaded
  if (demoDispatchers.length > 1) {
    map.fitBounds(bounds, { padding: 80, maxZoom: 15, duration: 800 });
  } else {
    const d = demoDispatchers[0];
    map.flyTo({ center: [d.long, d.lat], zoom: 14 });
  }
}

// Ensure render after map is fully ready
map.on('load', () => {
  setTimeout(() => {
    map.resize();
    renderDemoMarkers();
  }, 500);
});
</script>
{% endblock %}
