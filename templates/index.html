{% extends "base.html" %}
{% block title %}Home | Map Project{% endblock %}

{% block content %}
<div class="text-center">
  <h1 class="text-3xl font-bold mb-4">
    Welcome{% if user %}, {{ user.username }}{% endif %}
  </h1>

  <!-- Map Container -->
  <div class="max-w-lg mx-auto px-4">
    <div id="map" class="w-full h-80 md:h-96 rounded-xl shadow-md border-2 border-green-400 mb-6 transition duration-300 hover:shadow-lg hover:border-blue-500"></div>
  </div>

  <!-- Buttons -->
  <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-8">
    <button id="locate-btn" class="w-full sm:w-auto bg-blue-600 text-white px-5 py-2.5 rounded-lg shadow-md hover:bg-blue-700">üìç Show & Save My Location</button>
  </div>

  <!-- Locations List -->
  <div class="max-w-2xl mx-auto text-left">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Locations</h2>
    <div class="h-64 overflow-y-auto border rounded-lg shadow-inner bg-gray-50 p-2">
      <ul id="location-list" class="space-y-2">
        {% for loc in locations %}
          <li class="p-3 bg-white shadow rounded-md flex justify-between items-center transition-colors hover:bg-gray-100">
            <div>
              <div class="text-sm text-gray-600">{{ loc.name or 'Unnamed' }} </div>
              <div class="font-semibold text-gray-800">{{ "%.4f"|format(loc.lat|float) }}, {{ "%.4f"|format(loc.long|float) }}</div>
              <div class="text-sm text-gray-500">{{ loc.created_at.strftime('%b %d, %Y %I:%M %p') }}</div>
            </div>
            <button class="delete-btn text-red-500 hover:text-red-700 font-bold p-2 rounded-full transition-colors hover:bg-red-100" data-id="{{ loc.id }}">üóë</button>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="locationModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-xl shadow-xl w-96 p-6 relative">
    <h2 class="text-xl font-bold mb-4 text-gray-800">Save Location</h2>
    <label for="locationName" class="block text-sm font-medium text-gray-700 mb-2">Enter a name for this location:</label>
    <input type="text" id="locationName" placeholder="e.g. Home, Office, Market"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none">
    <div class="flex justify-end gap-2">
      <button id="cancelModal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
      <button id="saveModal" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save</button>
    </div>
  </div>
</div>

<script>
  // Map init
  mapboxgl.accessToken = "{{ mapbox_token }}";
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [2.5, 9.5],
    zoom: 4
  });

  let userMarker = null;
  let pendingCoords = null;

  // Show & Save My Location
  document.getElementById('locate-btn').addEventListener('click', e => {
    e.preventDefault();
    if (!navigator.geolocation) return alert("Geolocation not supported.");
    navigator.geolocation.getCurrentPosition(pos => {
      const lng = pos.coords.longitude, lat = pos.coords.latitude;
      map.flyTo({ center: [lng, lat], zoom: 13 });
      if (userMarker) userMarker.remove();
      userMarker = new mapboxgl.Marker({ color: 'blue' })
        .setLngLat([lng, lat])
        .setPopup(new mapboxgl.Popup().setText('You are here'))
        .addTo(map);
      pendingCoords = { lat, long: lng };
      document.getElementById('locationModal').classList.remove('hidden');
    }, err => alert("Unable to fetch location: " + err.message), { enableHighAccuracy: true });
  });

  // Cancel modal
  document.getElementById('cancelModal').addEventListener('click', () => {
    pendingCoords = null;
    document.getElementById('locationName').value = '';
    document.getElementById('locationModal').classList.add('hidden');
  });

  // Save location
  document.getElementById('saveModal').addEventListener('click', async () => {
    const name = document.getElementById('locationName').value.trim();
    if (!name) return alert("Please enter a name.");
    const body = { ...pendingCoords, name };
    const res = await fetch('/save_location', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (res.ok) {
      const j = await res.json();
      prependLocationToList(j.data);
    } else {
      alert("Failed to save location. You need to be logged in.");
    }
    pendingCoords = null;
    document.getElementById('locationName').value = '';
    document.getElementById('locationModal').classList.add('hidden');
  });

  // Delete location
  document.addEventListener('click', async e => {
    if (e.target.classList.contains('delete-btn')) {
      const id = e.target.dataset.id;
      if (!id) return;
      const res = await fetch(`/delete_location/${id}`, { method: 'DELETE' });
      if (res.ok) {
        e.target.closest('li').remove();
      } else {
        alert("Delete failed");
      }
    }
  });

  // Fetch all locations
  async function updateLocationsList() {
    try {
      const res = await fetch('/get_all_locations');
      if (!res.ok) return;
      const data = await res.json();
      const list = document.getElementById('location-list');

      const currentIds = new Set([...list.querySelectorAll('.delete-btn')].map(b => b.dataset.id));
      const newIds = new Set(data.map(l => String(l.id)));

      // Remove deleted ones
      for (const li of [...list.children]) {
        const id = li.querySelector('.delete-btn')?.dataset.id;
        if (id && !newIds.has(id)) li.remove();
      }

      // Add new ones
      for (const loc of data) {
        if (!currentIds.has(String(loc.id))) prependLocationToList(loc);
      }
    } catch (err) {
      console.error(err);
    }
  }

  // Add one new item to list
  function prependLocationToList(loc) {
    const list = document.getElementById('location-list');
    const li = document.createElement('li');
    li.className = "p-3 bg-white shadow rounded-md flex justify-between items-center transition-colors hover:bg-gray-100";
    li.innerHTML = `
      <div>
        <div class="text-sm text-gray-600">${loc.name || 'Unnamed'}</div>
        <div class="font-semibold text-gray-800">${parseFloat(loc.lat).toFixed(4)}, ${parseFloat(loc.long).toFixed(4)}</div>
        <div class="text-sm text-gray-500">${new Date(loc.created_at).toLocaleString()}</div>
      </div>
      <button class="delete-btn text-red-500 hover:text-red-700 font-bold p-2 rounded-full transition-colors hover:bg-red-100" data-id="${loc.id}">üóë</button>
    `;
    list.prepend(li);
  }

  // Run auto update forever
  updateLocationsList();
  setInterval(updateLocationsList, 500);
</script>

{% endblock %}
