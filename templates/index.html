{% extends "base.html" %}

{% block content %}

<style>
    .carousel-indicators-custom {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 15px;
        padding-bottom: 20px;
    }
    
    .indicator-dot {
        width: 8px;
        height: 8px;
        background-color: #e0e0e0; /* Gray for inactive */
        border-radius: 50%;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .indicator-dot.active {
        width: 24px; /* Stretch into a pill shape */
        background-color: #1a8917; /* Green for active */
        border-radius: 4px;
    }
</style>

<div class="hero-box">
    <div class="hero-overlay"></div>
    <div class="hero-content">
        <h1 class="display-4 text-white mb-3">Cooking gas delivered to your doorstep.</h1>
        <p class="lead text-white-50">Fast, reliable, and safe delivery service in Uyo.</p>
    </div>
</div>

<div class="contact-section">
    <div class="contact-item">
        <i class="bi bi-geo-alt"></i>
        <div>
            <strong>Visit our Station</strong>
            <span>Uyo, Akwa Ibom (Lat: 5.0117, Lng: 7.8616)</span>
        </div>
    </div>
    <div class="contact-item">
        <i class="bi bi-telephone"></i>
        <div>
            <strong>Call Support</strong>
            <span>+234 800 GAS EXPRESS</span>
        </div>
    </div>
    <div class="contact-item">
        <i class="bi bi-clock"></i>
        <div>
            <strong>Open Hours</strong>
            <span>Mon - Sat: 8am - 6pm</span>
        </div>
    </div>
</div>

<div class="mb-5">
    <div class="d-flex align-items-center justify-content-between mb-3 px-2">
        <h2>Select Cylinder Size</h2>
        <small class="text-muted">Swipe for more <i class="bi bi-arrow-right"></i></small>
    </div>

    <div class="horizontal-scroll" id="scrollContainer">
        {% for cylinder in cylinders %}
        <div class="scroll-card-wrapper" id="card-{{ loop.index0 }}">
            <div class="card h-100 border-0 shadow-sm">
                
                <div class="p-3" style="background-color: #f8f9fa;"> 
                <img src="{{ cylinder.image_url }}"
                     class="card-img-top" 
                     alt="{{ cylinder.name }}"
                     style="height: 180px; object-fit: contain; width: 100%;">
            </div>

                <div class="card-body text-center">
                    <h3 class="card-title h5">{{ cylinder.name }}</h3>
                    <h2 class="price-tag my-3">{{ "{:,.2f}".format(cylinder.price) }}
                    
                    {% if user %}
                        <button id="btn-{{ cylinder.id }}" 
                                onclick="initiateOrder('{{ cylinder.id }}', '{{ cylinder.price }}', '{{ user.email }}')" 
                                class="btn btn-primary w-100 mt-2">
                            Buy Now
                        </button>
                    {% else %}
                        <a href="/login" class="btn btn-outline-primary w-100 mt-2">Login to Order</a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="carousel-indicators-custom">
        {% for cylinder in cylinders %}
            <div class="indicator-dot {% if loop.first %}active{% endif %}" 
                 onclick="scrollToCard({{ loop.index0 }})">
            </div>
        {% endfor %}
    </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
    // --- PAGINATION LOGIC ---
    document.addEventListener("DOMContentLoaded", function() {
        const container = document.getElementById('scrollContainer');
        const cards = document.querySelectorAll('.scroll-card-wrapper');
        const dots = document.querySelectorAll('.indicator-dot');

        // Observer Options: Trigger when 60% of the card is visible
        const options = {
            root: container,
            threshold: 0.6
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Find which card this is
                    const index = Array.from(cards).indexOf(entry.target);
                    
                    // Update dots
                    dots.forEach(d => d.classList.remove('active'));
                    if(dots[index]) {
                        dots[index].classList.add('active');
                    }
                }
            });
        }, options);

        // Observe all cards
        cards.forEach(card => observer.observe(card));
    });

    // Click dot to scroll to card
    function scrollToCard(index) {
        const card = document.getElementById(`card-${index}`);
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }

    // --- ORDERING LOGIC (Existing) ---
    function initiateOrder(id, price, email) {
        const btn = document.getElementById(`btn-${id}`);
        const originalText = btn.innerText;

        // 1. UI Feedback
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> üìç Locating...`;

        // 2. Get Location
        if(!navigator.geolocation) {
            alert("Geolocation is not supported by your browser");
            resetBtn(btn, originalText);
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const coords = { 
                    lat: position.coords.latitude, 
                    lng: position.coords.longitude 
                };

                // 3. Proceed to Paystack
                btn.innerHTML = "Secure Payment...";
                launchPaystack(id, price, email, coords, btn, originalText);
            }, 
            (error) => {
                alert("‚ö†Ô∏è Error: We cannot deliver without your location. Please allow location access.");
                console.error(error);
                resetBtn(btn, originalText);
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    function launchPaystack(id, price, email, coords, btn, originalText) {
        const handler = PaystackPop.setup({
            key: '{{ paystack_key }}',
            email: email,
            amount: price * 100, // Convert to kobo
            currency: 'NGN',
            ref: ''+Math.floor((Math.random() * 1000000000) + 1),
            
            onClose: function(){
                alert('Payment window closed.');
                resetBtn(btn, originalText);
            },
            callback: function(response){
                verifyBackend(response.reference, id, coords, btn, originalText);
            }
        });
        handler.openIframe();
    }

    async function verifyBackend(ref, id, coords, btn, originalText) {
        btn.innerHTML = "Verifying...";
        try {
            const res = await fetch('/verify-payment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ reference: ref, cylinder_id: id, coords: coords })
            });
            const data = await res.json();
            
            if(data.status === 'success') {
                window.location.href = "/my-orders"; 
            } else {
                alert("Payment verification failed!");
                resetBtn(btn, originalText);
            }
        } catch (e) {
            console.error(e);
            alert("Network error");
            resetBtn(btn, originalText);
        }
    }

    function resetBtn(btn, text) {
        btn.disabled = false;
        btn.innerText = text;
    }
</script>
{% endblock %}