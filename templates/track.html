{% extends "base.html" %}
{% block title %}Track Order{% endblock %}
{% block content %}
<h3 class="text-lg font-semibold mb-3">Tracking: {{ order.title }}</h3>
<p class="text-sm text-slate-500 mb-3">Status: <span id="status-text">{{ order.status }}</span></p>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <div class="bg-white p-3 rounded shadow">
    {% if order.image_path %}
      <img src="{{ order.image_path }}" class="w-full rounded mb-3" />
    {% endif %}
    <p class="text-sm">Pickup: {{ order.location.name if order.location else 'Unknown' }}</p>
    <p class="text-sm">Share this link: <code class="break-all">/track/{{ order.code }}</code></p>
  </div>

  <div class="bg-white p-3 rounded shadow">
    <div id="mini-map" style="width:100%;height:320px"></div>
    <p class="text-sm mt-2">Dispatcher: <span id="dispatcher-name">{{ order.dispatcher.username if order.dispatcher else 'Not assigned' }}</span></p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
mapboxgl.accessToken = "{{ MAPBOX_TOKEN }}";
const mini = new mapboxgl.Map({ container:'mini-map', style:'mapbox://styles/mapbox/streets-v12', center:[{{ order.location.long if order.location else 3.3792 }}, {{ order.location.lat if order.location else 6.5244 }}], zoom:12 });
mini.addControl(new mapboxgl.NavigationControl());

let riderMarker = null;
let destMarker = null;
if({{ 'true' if order.location else 'false' }}){
  destMarker = new mapboxgl.Marker({ color: 'blue' }).setLngLat([{{ order.location.long if order.location else 3.3792 }}, {{ order.location.lat if order.location else 6.5244 }}]).addTo(mini);
}

async function fetchStatus(){
  try{
    const res = await fetch('/order_status/{{ order.id }}');
    if(!res.ok) return;
    const j = await res.json();
    document.getElementById('status-text').innerText = j.status;
    document.getElementById('dispatcher-name').innerText = j.dispatcher || 'Not assigned';
    if(j.dispatcher_lat && j.dispatcher_long){
      const lng = j.dispatcher_long, lat = j.dispatcher_lat;
      if(!riderMarker){
        riderMarker = new mapboxgl.Marker({ color: 'orange' }).setLngLat([lng, lat]).addTo(mini);
      } else {
        riderMarker.setLngLat([lng, lat]);
      }
      // keep both visible
      const b = new mapboxgl.LngLatBounds();
      if(destMarker) b.extend(destMarker.getLngLat());
      b.extend([lng, lat]);
      mini.fitBounds(b, { padding: 60, maxZoom: 15, duration: 600 });
    }
  }catch(e){ console.error(e); }
}
fetchStatus();
setInterval(fetchStatus, 3000);
</script>
{% endblock %}
